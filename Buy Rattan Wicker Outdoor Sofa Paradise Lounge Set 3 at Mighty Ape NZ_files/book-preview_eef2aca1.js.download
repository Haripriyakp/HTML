MA.bookPreviewLoader=function(){'use strict';var title;var author;var identifiers;var apiKey;var thumbnailUrl;var volume;var bookPreview;function init(config){title=config.title;author=config.author;identifiers=config.identifiers;apiKey=config.apiKey;thumbnailUrl=config.thumbnailUrl;var searchQuery='intitle:"'+title+'"';if(author!==''){searchQuery+='+"'+author+'"';}
$.ajax({url:'https://www.googleapis.com/books/v1/volumes',type:'GET',data:{'q':searchQuery,'filter':'partial','fields':'items(volumeInfo,accessInfo,id)','langRestrict':'en','key':apiKey},success:function(data){volume=selectBestVolume(data.items||[]);if(volume!=null){renderPreviewLinks();registerEvents();}}});}
function selectBestVolume(items){var selectedVolume=null;$.each(items,function(index,volume){if(volume.accessInfo.embeddable){var foundIsbnMatch=false;if(volume.volumeInfo.industryIdentifiers!=null){$.each(volume.volumeInfo.industryIdentifiers,function(index,industryIdentifier){if(industryIdentifier.type==='ISBN_13'||industryIdentifier.type==='ISBN_10'){if($.inArray(industryIdentifier.identifier,identifiers)){selectedVolume=volume;foundIsbnMatch=true;return false;}}});}
if(foundIsbnMatch){return false;}
if(selectedVolume==null){selectedVolume=volume;}}});return selectedVolume;}
function renderPreviewLinks(){var $thumbnailContainer=$('div.thumbs');var $thumbnailTemplate=$('#bookPreviewThumbnailTemplate');var $viewMoreLink=$('div.thumbs div.view-more-images');var numThumbs=$thumbnailContainer.find('div.image').length;$('div.main-image div.curl').show();if(numThumbs>0){$thumbnailContainer.find('div.image').first().before($thumbnailTemplate.html());$thumbnailContainer.removeClass('thumb-'+numThumbs);if(numThumbs+1<5){$thumbnailContainer.addClass('thumb-'+(numThumbs+1));}else{$thumbnailContainer.find('div.image').last().remove();$viewMoreLink.removeClass('hidden');}
$thumbnailContainer.find('div.book-preview-button').slideDown(300);}
$('div.image-gallery .thumbnails .owl-carousel').append('<img class="owl-lazy show-preview" src="'+thumbnailUrl+'" data-src="'+thumbnailUrl+'" width="100" height="100" alt="look inside" border="0"/>');}
function registerEvents(){$(document).on('click.BookPreview','div.main-image div.curl, div.image-gallery .show-preview',showPreview);$('.thumbs div.book-preview-button span a').off('click.MA_ImageGallery').on('click.MA_BookPreview',function(e){e.preventDefault();showPreview();});}
function showPreview(){if(bookPreview==null){bookPreview=new MA.BookPreview();bookPreview.init({volume:volume});}
bookPreview.open();}
return{'init':init}}();MA.BookPreview=function(){'use strict';var $bookPreview;var $viewerContainer;var volume;var viewer;function init(config){volume=config.volume;$bookPreview=$('div.book-preview');$viewerContainer=$('div#preview-viewer');$bookPreview.find('.title var').text(volume.volumeInfo.title);}
function open(){$('html').addClass('show-book-preview');MA.utils.hideChatWidget();$bookPreview.show();if(viewer==null){loadViewer();}
registerEvents();}
function close(){$bookPreview.hide();$('html').removeClass('show-book-preview');MA.utils.showChatWidget();unregisterEvents();}
function loadViewer(){$viewerContainer.addClass('loading');viewer=new google.books.DefaultViewer(document.getElementById('preview-viewer'),{'showLinkChrome':false});viewer.load(volume.id,function(){close();MA.notices.add('An error occurred when previewing this book. Please try again.');},function(){$viewerContainer.removeClass('loading');});}
function registerEvents(){$(document).on('keydown.MA_BookPreview',function(e){if(e.keyCode===27){close();}});$(window).on('resizeEnd.MA_BookPreview',function(){viewer.resize();});$bookPreview.on('click','header .title a',function(e){e.preventDefault();close();});$bookPreview.on('click','div.load.prev',function(){viewer.previousPage();});$bookPreview.on('click','div.load.next',function(){viewer.nextPage();});$bookPreview.on('click','button.zoom-in',function(){viewer.zoomIn();});$bookPreview.on('click','button.zoom-out',function(){viewer.zoomOut();});}
function unregisterEvents(){$(document).off('.MA_BookPreview');}
return{init:init,open:open,close:close};};