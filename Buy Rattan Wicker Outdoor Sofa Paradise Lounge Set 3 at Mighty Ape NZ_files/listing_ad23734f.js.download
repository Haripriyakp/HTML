MA.ListingPage=function(){'use strict';var initReferrals=function(){$('section.referral-link input[name=referralLink]').click(function(e){$(this).focus();$(this).select();e.preventDefault();});};var initAdminOptions=function(){$(document).on('click','a.admin-options',function(e){e.preventDefault();var $optionsContainer=$('div.admin-options');if($optionsContainer.is(':empty')){$optionsContainer.addClass('loading').show();$.ajax({url:$(this).data('ajaxAction'),type:'GET',dataType:'html',success:function(data){$optionsContainer.html(data).removeClass('loading');},error:function(){$optionsContainer.removeClass('loading').hide();MA.notices.add('An error occurred when loading admin options. Please try again.');},});}else{$optionsContainer.empty().hide();}});$(document).on('change','form.covid-essentials-toggle input[type="radio"]',function(e){$('form.covid-essentials-toggle').submit();});};var initProductHunt=function(){$('body.logged-in a#product-hunt-item').click(function(e){e.preventDefault();$.ajax({url:$(this).data('ajaxAction'),type:'GET',dataType:'json',success:function(data){$('#product-hunt-message').text(data.message);$('#product-hunt-image').trigger('mouseenter');$('#product-hunt-image').unbind('mouseleave');}});});$('#product-hunt-image').hover(function(){this.src=$(this).data('activeSrc');},function(){this.src=$(this).data('inactiveSrc');});};var initBundles=function(){$('form.bundle-form').each(function(i,form){$(form).submit(function(e){var $bundleForm=$(this);if($bundleForm.data('bundleType')==2){var itemsAvailable=$bundleForm.data('totalItemsAllowed')-$bundleForm.find('input[type=checkbox]:checked').length;if(itemsAvailable>0){e.preventDefault();return false;}}
addToTrolley($bundleForm);e.preventDefault();});});$('form.bundle-form button.choose-button').click(function(e){e.preventDefault();var $bundleForm=$('form.bundle-form');var $button=$(this);var $buttonText=$button.find('span');var $checkbox=$button.parents('label.choose-bundle-item').find('input[type=checkbox]');var $item=$button.parents('div.scrollable-list div.item > div');var itemsAvailable=0;if($checkbox.is(':checked')){$('form.bundle-form > div.message').addClass('hidden');$checkbox.prop('checked',false);$button.removeClass('chosen');$buttonText.html('Choose this');itemsAvailable=$bundleForm.data('totalItemsAllowed')-$bundleForm.find('input[type=checkbox]:checked').length;}else{itemsAvailable=$bundleForm.data('totalItemsAllowed')-$bundleForm.find('input[type=checkbox]:checked').length;if(itemsAvailable>0){$checkbox.prop('checked',true);$buttonText.html('Chosen');$button.addClass('chosen');itemsAvailable--;}else{$('form.bundle-form > div.message').removeClass('hidden');}}
if(itemsAvailable==0){$bundleForm.find('input[type=checkbox]:not(:checked)').each(function(i,checkbox){$(checkbox).parents('label.choose-bundle-item').find('button.choose-button').find('span').html('Not chosen');});}else{$bundleForm.find('input[type=checkbox]:not(:checked)').each(function(i,checkbox){$(checkbox).parents('label.choose-bundle-item').find('button.choose-button').removeClass('chosen').find('span').html('Choose this');});}
var $bundleItems=$bundleForm.find('.bundle-items');var bundledPrice=0.00;$bundleItems.html('');bundledPrice+=parseFloat($('span.primary-product-price').data('price'));$bundleForm.find('div.item').each(function(i,item){$item=$(item);if($item.find('input[type=checkbox]:checked').length===0){return;}
var $title=$item.find('div.title a');var $format=$item.find('div.format a');var $price=$item.find('div.product-price');var titleHtml=$title.html();if($format.length>0){titleHtml+=' ~ '+$format.html();}
var bundleItemHtml='<div><span>'+titleHtml+'</span><span>'+$price.html()+'</span></div>';$bundleItems.append(bundleItemHtml);var itemPrice=parseFloat($price.data('price'));if(!isNaN(itemPrice)){bundledPrice+=itemPrice;}});var $addBundleButton=$bundleForm.find('.add-bundle-to-trolley-button');if($bundleForm.data('bundleType')==2){if(itemsAvailable==0){$addBundleButton.removeClass('disabled');}else{$addBundleButton.addClass('disabled');for(var i=1;i<=itemsAvailable;i++){$bundleItems.append('<div class="unselected-item"><span>Please select your free bonus</span><span></span></div>');}}}else if($bundleForm.data('bundleType')==3){if($bundleForm.find('input[type=checkbox]:checked').length>0){$addBundleButton.html('Add Bundle to Trolley');}else{$addBundleButton.html('Add to Trolley');}}
$bundleForm.find('span.bundle-total-cost').html('$'+MA.utils.numberFormat(bundledPrice,2));});$('label.choose-bundle-item input[type=checkbox]').hide();};var initTrolleyButtons=function(){var $page=$('div.page');$('form.add-to-trolley').each(function(i,form){$(form).submit(function(e){addToTrolley($(this));e.preventDefault();fbq('track','AddToCart',{content_ids:[$(this).data('facebookPixelContentId')],content_type:'product'});pintrk('track','AddToCart',$(this).data('pinterestEventData'));if(typeof callCertona!=='undefined'){callCertona({itemid:$(this).data('certonaItemId'),event:'addtocart',});}});});$('#dirty').on('fetched.pageState',function(e,response){for(var i=0;i<response.listings.length;i++){var listing=response.listings[i];if(listing.id!==parseInt($page.find('main').data('listing'))){continue;}
updateTrolleyButtonState(listing.quantityInTrolley,null);}});};var initBuyTogether=function(){$('form.buyTogether').each(function(i,form){$(form).submit(function(e){addToTrolley($(this));e.preventDefault();fbq('track','AddToCart',{content_ids:[$(this).data('facebookPixelContentIdOne'),$(this).data('facebookPixelContentIdTwo'),],content_type:'product'});pintrk('track','AddToCart',$(this).data('pinterestEventData'));if(typeof callCertona!=='undefined'){callCertona({itemid:$(this).data('certonaItemId'),event:'addtocart',});}});});};var initWishlist=function(){$('body.logged-in .wishlist-button').click(function(e){e.preventDefault();fbq('track','AddToWishlist',{content_ids:[$(this).data('facebookPixelContentId')],content_type:'product'});if(typeof callCertona!=='undefined'){callCertona({itemid:$(this).data('certonaItemId'),event:'addtowishlist',});}});};var initDeliveryEstimator=function(){$(document.body).on('change','.delivery-estimator select[name="deliveryRegionId"]',function(){var $estimator=$('.delivery-estimator');var $form=$(this).closest('form');$estimator.addClass('loading');$.ajax({type:'POST',url:$form.attr('action'),dataType:'html',data:$form.serialize(),success:function(data){$estimator.replaceWith(data);$estimator=$('.delivery-estimator');$estimator.find('select[name="deliveryRegionId"]').focus();},error:function(xhr,ajaxOptions,thrownError){MA.notices.add('An error occurred when loading delivery estimates. Please try again.');},complete:function(xhr,textStatus){$estimator.removeClass('loading');}})});};var showFull=function($container){$container.removeClass('crop');$container.addClass('expanded');$container.find('div.more-less').html('<a class="show-less-link" href="#">Read less<span class="icon-dropdown-arrow"></span></a>');};var showLess=function($container){var elementHeight=$container.height();var numChildren=$container.find('div.content').children().length;var cropHeight=275;var shouldCropContent=false;if(elementHeight>cropHeight+48){if($container.closest('section').hasClass('customer-reviews')){shouldCropContent=true;}else if($container.closest('section').hasClass('description-and-details')&&numChildren>4){shouldCropContent=true;}}
$container.find('a.more.show').remove();if(shouldCropContent===true){if(!($container).hasClass('expanded')){$container.addClass('crop');$container.find('div.more-less').html('<a class="read-more-link" href="#">Read more<span class="icon-dropdown-arrow"></span></a>');$container.find('div.more-less').show();}else{$container.find('div.more-less').html('<a class="show-less-link" href="#">Read less<span class="icon-dropdown-arrow"></span></a>');$container.find('div.more-less').show();}}};var initCropContent=function(){cropContent();$(window).on('resizeEnd',resizeHandler);$(document).on('click','.read-more-link',function(e){showFull($(this).closest('.cropable'));e.preventDefault();});$(document).on('click','.show-less-link',function(e){$(this).closest('.cropable').removeClass('expanded');showLess($(this).closest('.cropable'));e.preventDefault();});function cropContent(e){$('.cropable').each(function(i,item){showLess($(item));});}
function resizeHandler(e){$('.cropable').each(function(i,item){if($(item).hasClass('crop')){$(item).removeClass('crop');}
$(item).find('div.more-less').empty().hide();cropContent();});}};var addToTrolley=function($form){$.ajax({url:$form.data('ajaxAction'),type:'POST',cache:false,timeout:30*1000,data:$form.serializeArray(),dataType:'json',context:this,success:function(data,textStatus,XHR){if(data.status=='1'){updateTrolleyButtonState(data.itemQuantity,data.redirect);MA.header.updateTrolleyInfo(data.trolleyItemCount,data.trolleySubtotal);if(typeof gtag==='function'){try{gtag('event','page_view',{'page_path':$form.attr('action')});}catch(e){console.log(e);}}
if(data.redirect){window.location.href=data.redirect;}
return;}
if(data.status=='2'){if(data.redirect){window.location.href=data.redirect;}else{window.location.reload(true);}
return;}
MA.notices.add(data.error+' . <a href="'+data.trolleyUrl+'"><b>View Trolley</b></a>');},error:function(XHR,textStatus,errorThrown){MA.notices.add('An error occurred while trying to add the item to your trolley: '+textStatus+'\n\n'+'Please click the Add to Trolley button again to retry.');}});};var updateTrolleyButtonState=function(quantityInTrolley,linkUrl){if(quantityInTrolley>0){$('div.page').removeClass('not-in-trolley').addClass('in-trolley');$('div.trolley-button-section').find('.quantity').text(quantityInTrolley);if(linkUrl){$('div.trolley-button-section').find('a.in-trolley-button').attr('href',linkUrl);}}else{$('div.page').addClass('not-in-trolley').removeClass('in-trolley');}};var updateMainImage=function($selected){'use strict';var $mainImageWrapper=$('div.summary-images div.main-image span.image');var $mainImageLink=$('div.summary-images div.main-image div.image-wrapper span.image a');var $selectedContainer=$selected.parents('span.image');$mainImageLink.data('image',$selected.data('image'));if($selectedContainer.hasClass('adult')){if(!$mainImageWrapper.hasClass('adult')){$mainImageWrapper.addClass('adult');}
$mainImageLink.find('img').attr('src',$selected.data('mainImageSrc'));}else{$mainImageLink.find('img').attr('src',$selected.data('mainImageSrc'));$mainImageWrapper.removeClass('adult');}
$('div.thumbs div.images div.image.active').removeClass('active');$selected.closest('div.image').addClass('active');};return{initReferrals:initReferrals,initAdminOptions:initAdminOptions,initProductHunt:initProductHunt,initBundles:initBundles,initTrolleyButtons:initTrolleyButtons,initBuyTogether:initBuyTogether,initWishlist:initWishlist,initDeliveryEstimator:initDeliveryEstimator,initCropContent:initCropContent,updateMainImage:updateMainImage};};